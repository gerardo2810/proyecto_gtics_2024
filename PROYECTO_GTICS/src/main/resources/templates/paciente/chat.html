<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec = "http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <!--=============== REMIXICONS ===============-->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet">
    <!--=============== CSS ===============-->
    <!-- Font Awesome -->

    <script src="https://kit.fontawesome.com/a2dd6045c4.js" crossorigin="anonymous"></script>


    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/fonts.css}">
    <link rel="stylesheet" th:href="@{/css/topbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/scrollbar.css}">
    <link rel="stylesheet" th:href="@{/css/paciente/paciente.css}">
    <link rel="stylesheet" th:href="@{/css/paciente/chat.css}">
    <link rel="stylesheet" th:href="@{/css/datatables.css}">
    <link rel="stylesheet" th:href="@{/css/boostrap-datatables.css}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.css" integrity="sha512-0Nyh7Nf4sn+T48aTb6VFkhJe0FzzcOlqqZMahy/rhZ8Ii5Q9ZXG/1CbunUuEbfgxqsQfWXjnErKZosDSHVKQhQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />


    <!--=============== DataTable ===============-->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css"/>
    <!--  Bootstrap-->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.min.css"/>
    <!--==========================================-->

    <title>Mensajería | Bienestar San Miguel</title>

    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px #a5aaad;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #0d6efd;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #0d6efd;
        }

        .container2 {
            border: 2px solid #dedede;
            background-color: #f1f1f1;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        /* Darker chat container */
        .darker {
            border-color: #ccc;
            background-color: #ddd;
        }

        /* Clear floats */
        .container2::after {
            content: "";
            clear: both;
            display: table;
        }

        /* Style images */
        .container2 img {
            float: left;
            max-width: 60px;
            width: 100%;
            margin-right: 20px;
            border-radius: 50%;
        }

        /* Style the right image */
        .container2 img.right {
            float: right;
            margin-left: 20px;
            margin-right:0;
        }

        /* Style time text */
        .time-right {
            float: right;
            color: #aaa;
        }

        /* Style time text */
        .time-left {
            float: left;
            color: #999;
        }
        /* Estilos para el input de texto */
        .container2:last-child {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px; /* Espacio entre el último mensaje y el input */
        }

        .container2:last-child input[type="text"] {
            width: 70%; /* Ancho del input */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px; /* Espacio entre el input y el botón */
            box-sizing: border-box;
        }

        /* Estilos para el botón de enviar */
        .container2:last-child button {
            background-color: #4CAF50; /* Color de fondo */
            color: white; /* Color del texto */
            padding: 10px 20px; /* Espaciado interno */
            border: none; /* Sin borde */
            border-radius: 5px; /* Borde redondeado */
            cursor: pointer; /* Cursor al pasar */
        }

        /* Estilos para el icono del botón */
        .container2:last-child button i {
            margin-right: 5px; /* Espacio entre el icono y el texto */
        }
        .area {
            height: 12vh !important;
        }

        .circles {
            height: 19vh !important;
        }

        .banner-btn {
            color: #fff !important;
            border: solid 1px #fff !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            align-items: center !important;
            display: flex !important;
            background: none !important;
        }

        .bell-btn {
            padding: 14px 14px 14px 14px;
            font-size: 1.1rem !important;
        }

        .user-btn {
            padding: 13px 14px 13px 14px;
            font-size: 1.1rem !important;
        }

        .exit-btn {
            padding: 14px 12px 14px 12px;
            font-size: 1.1rem !important;
        }
    </style>


    <style>


        .kapsayici{
            display:flex;
            padding:5px;
            text-align:center;
            max-width:500px;
            min-width:0px;
            height:auto;
            margin:200px auto;
            flex-direction: row;
            align-items: center;

        }


        .emoji{
            max-width:30px;
            border-radius:50%;
            cursor:pointer;
        }
        .bar{
            width:200px;
            height:170px;
            border-radius:10px;
            background:#fff;
            position:absolute;
            right:10px;
            top:40px;
            box-shadow:0px 0px 20px 0px #272727;
            visibility:hidden;
            opacity:0;
            display:flex;

            font-size:35px;
            transition:all 0.3s;
        }
        .emoji:focus + .bar{
            top:60px;
            visibility:visible;
            opacity:1;
        }
        .bar:focus{
            top:60px;
            visibility:visible;
            opacity:1;
        }
        .emoticon{
            padding:10px;
            border-radius:50%;
            cursor:pointer;
            transition:all 0.3s;
        }
        .emoticon:hover{
            background:mediumslateblue;
            color:white;
            cursor: pointer;
        }
    </style>
</head>




<body>


<header class="header-topbar">
    <nav th:replace="~{fragments/navbar.html :: navbar( active = 'Mensajeria')}"></nav>
</header>


<div th:replace="~{fragments/banner.html :: banner}"></div>



<div class="container">

    <div style="margin-bottom: 50px"></div>
    <h2><i class="fa-solid fa-star" style="color: #8de7ef;"></i><strong style="padding-left: 10px" >Orden XYZWXZ</strong></h2>
    <div style="margin-bottom: 20px"></div>
    <hr style="border-top: 1px solid #DFDFDF;">
    <div style="margin-bottom: 40px"></div>

    <div style="padding-right: 0; padding-left: 0"> </div>
    <div style="padding-top:1px; display:flex; justify-content: end " >
        <a class="btn-p" href="/paciente/mensajeria">Regresar a la lista de chats</a>

    </div>
</div>


<br>

<div class="container" style="display: flex; flex-direction: row; column-gap: 60px">




    <div>

        <section class="Chat">
            <div class="ChatHead">
                <li class="group">
                    <div><img width="64" height="64" src="https://img.icons8.com/external-creatype-flat-colourcreatype/64/external-doctor-medic-health-creatype-flat-colourcreatype-2.png" alt="external-doctor-medic-health-creatype-flat-colourcreatype-2"/></div>
                    <p class="GroupName" th:text="${ 'Farmacista: ' +   farmacista.getNombres() + ' ' + farmacista.getApellidos()}"></p>

                </li>
                <div class="callGroup">

                </div>
            </div>
            <div class="MessageContainer">


                <div th:each="mensaje, index : ${mensajes}">


                    <th:block th:with="currentDate=${mensaje.getFormattedDate()}">
                        <!-- Mostrar fecha solo si es el primer mensaje o si la fecha es diferente al mensaje anterior -->
                        <th:block th:if="${index.index == 0 or mensajes[index.index - 1].getFormattedDate() != currentDate}">
                            <div class="message-date">
                                <div class="messageSeperator" th:text="${currentDate}"></div>
                            </div>
                        </th:block>
                    </th:block>


                    <div th:switch="${mensaje.getIdRol()}">


                        <div th:case="'F'" class="message you">
                            <p class="messageContent" th:text="${mensaje.getMensaje()}"></p>
                            <div class="messageDetails">
                                <div class="messageTime" th:text="${mensaje.getFormattedTime()}"></div>
                            </div>
                        </div>


                        <div th:case="'P'">
                            <div  class="message me">
                                <p class="messageContent" th:text="${mensaje.getMensaje()}"></p>
                                <div class="messageDetails">
                                    <div class="messageTime" th:text="${mensaje.getFormattedTime()}"></div>
                                </div>
                            </div>

                        </div>





                    </div>

                </div>





                <div id="messageArea">

                </div>

            </div>

            <div style="display: flex; flex-direction: row; column-gap: 10px; padding: 15px">

                <input type="text" id="messageInput" class="inputMensaje" style="width: 300px" placeholder="Ingrese su mensaje">


                <button onclick="sendMessage()" class="enviar-msg" id="botonEnviar"><i class="fa-solid fa-paper-plane"></i></button>

            </div>





        </section>




    </div>

    <div style="display: flex; flex-direction: column;justify-content: center; width: 800px">
        <div>
            <table id="miTabla2" class="table table-striped">
                <h2>Medicamentos con Stock</h2>
                <thead>
                <tr style="background-color: #378fff">
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Medicamento</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Imagen</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Cantidad</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Precio unitario</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Precio total</th>
                </tr>
                </thead>

                <tbody>

                    <tr th:each="itemDeLaOrden: ${medicamentosEnStock}">
                        <td th:text="${itemDeLaOrden.getIdMedicamento().nombre}"></td>
                        <td><img th:src="'data:image/jpeg;base64,' + ${itemDeLaOrden.getIdMedicamento().imagenBase64}" class="medicamento"/></td>
                        <td th:text="${itemDeLaOrden.getCantidad()}"></td>
                        <td th:text="${itemDeLaOrden.getIdMedicamento().precioVenta}"></td>

                        <td class="resultado"></td>

                        <script th:inline="javascript">
                            function limitarDigitos(numero) {
                                var numeroStr = numero.toString();
                                // Obtener los primeros 4 dígitos
                                var primerosCuatroDigitos = numeroStr.substring(0, 4);
                                var numeroLimitado = parseFloat(primerosCuatroDigitos);
                                return numeroLimitado;
                            }
                            var precioVenta = [[${itemDeLaOrden.getIdMedicamento().precioVenta}]];
                            var cantidad = [[${itemDeLaOrden.getCantidad()}]];
                            var resultado = precioVenta * cantidad;
                            var resultadoLimitado = limitarDigitos(resultado);
                            document.currentScript.parentElement.querySelector(".resultado").textContent = resultadoLimitado;
                        </script>

                    </tr>


                </tbody>
            </table>
        </div>
        <br>
        <br>

        <div>
            <table id="miTabla3" class="table table-striped">
                <h2>Medicamentos sin Stock</h2>
                <thead>
                <tr style="background-color: #378fff">
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Medicamento</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Imagen</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Cantidad</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Precio unitario</th>
                    <th style="text-align: center; color: #ffffff; font-weight: normal !important;">Precio total</th>
                </tr>
                </thead>


                <tbody>

                    <tr th:each="itemDeLaOrden: ${medicamentosSinStock}">
                        <td th:text="${itemDeLaOrden.getIdMedicamento().nombre}"></td>
                        <td><img th:src="'data:image/jpeg;base64,' + ${itemDeLaOrden.getIdMedicamento().imagenBase64}" class="medicamento"/></td>
                        <td th:text="${itemDeLaOrden.getCantidad()}"></td>
                        <td th:text="${itemDeLaOrden.getIdMedicamento().precioVenta}"></td>

                        <td class="resultado"></td>

                        <script th:inline="javascript">
                            function limitarDigitos(numero) {
                                var numeroStr = numero.toString();
                                // Obtener los primeros 4 dígitos
                                var primerosCuatroDigitos = numeroStr.substring(0, 4);
                                var numeroLimitado = parseFloat(primerosCuatroDigitos);
                                return numeroLimitado;
                            }
                            var precioVenta = [[${itemDeLaOrden.getIdMedicamento().precioVenta}]];
                            var cantidad = [[${itemDeLaOrden.getCantidad()}]];
                            var resultado = precioVenta * cantidad;
                            var resultadoLimitado = limitarDigitos(resultado);
                            document.currentScript.parentElement.querySelector(".resultado").textContent = resultadoLimitado;
                        </script>

                    </tr>

                </tbody>
            </table>
            <br>
            <br>
            <br>

        </div>

    </div>


</div>


<br>
<br>
<br>
<br>
<br>





<div th:replace="~{fragments/navbar.html :: footer}">
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.js" integrity="sha512-aGWPnmdBhJ0leVHhQaRASgb0InV/Z2BWsscdj1Vwt29Oic91wECPixuXsWESpFfCcYPLfOlBZzN2nqQdMxlGTQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    //$("#messageInput").emojioneArea()
</script>

<script th:src="@{/js/topbar.js}"></script>


<script  th:inline="javascript">


    const messageInput = document.getElementById("messageInput");
    messageInput.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    let idUserOnpage = /*[[${idUser}]]*/ '';
    let userId1 = /*[[${userId1}]]*/ '';
    let userId2 = /*[[${userId2}]]*/ '';
    let ordenId = /*[[${idOrden}]]*/ '';
    var ipLocal = /*[[${iplocal}]]*/ '';


    console.log(ipLocal)
    console.log('idUserOnpage:', idUserOnpage);
    console.log('userId1:', userId1);
    console.log('userId2:', userId2);

    //let socket = new WebSocket("ws://34.121.204.43:8080/chat/" + ordenId + '/' + userId1 + "/" + userId2);
    let socket = new WebSocket("ws://" + ipLocal + ":8080/chat/" + ordenId + '/' + + userId1 + "/" + userId2);

    socket.onmessage = function (event) {

        let messageArea = document.getElementById("messageArea");
        var fechaActual = new Date();
        var horaActual = fechaActual.getHours();
        var minutosActuales = fechaActual.getMinutes();
        var periodo = horaActual >= 12 ? 'p.m.' : 'a.m.';
        if (horaActual > 12) {
            horaActual -= 12;
        } else if (horaActual === 0) {
            horaActual = 12;
        }
        var minutosFormateados = minutosActuales < 10 ? '0' + minutosActuales : minutosActuales;


        var tiempoActual = horaActual + ':' + minutosFormateados + ' ' + periodo;


        // Parsear el mensaje JSON recibido
        var messageData = JSON.parse(event.data);

        // Verificar si el mensaje pertenece al usuario 1 o usuario 2
        if (messageData.senderId === userId1) {
            // Mensaje enviado por el usuario 1 (izquierda)
            messageArea.innerHTML += '<div class="message you">\n' +
                '    <p class="messageContent">' + messageData.message +
                '    </p><div class="messageDetails">\n' +
                '        <div class="messageTime">' + tiempoActual +
                '        </div>\n' +
                '    </div>\n' +
                '</div>';
        } else if (messageData.senderId === userId2) {
            // Mensaje enviado por el usuario 2 (derecha)
            messageArea.innerHTML += '<div class="message me">\n' +
                '    <p class="messageContent">' + messageData.message +
                '    </p><div class="messageDetails">\n' +
                '        <div class="messageTime">' + tiempoActual +
                '        </div>\n' +
                '    </div>\n' +
                '</div>';
        }


    }

    function sendMessage() {
        let messageInput = document.getElementById("messageInput");
        let message = messageInput.value.trim();

        if (message !== '') {

            if (idUserOnpage.toString() === userId1) {

                let messageObject = {
                    senderId: userId2,
                    message: message,
                    userRol: "P",
                    timestamp: new Date().toISOString(),
                    idChat: /*[[${idChat}]]*/ ''
                };

                socket.send(JSON.stringify(messageObject));
                messageInput.value = '';

            }else {

                let messageObject = {
                    senderId: userId1,
                    message: message,
                    userRol: "F",
                    timestamp: new Date().toISOString(),
                    idChat: /*[[${idChat}]]*/ ''
                };

                socket.send(JSON.stringify(messageObject));
                messageInput.value = '';

            }

        }

    }

</script>


<script>
    $(document).ready(function() {
        var table = $('#miTabla2').DataTable({
            "pageLength":3,
            "lengthChange": false,
            "language": {
                "emptyTable": "No hay registros disponibles",
                "zeroRecords": "No se encontraron registros coincidentes",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "search" : "Buscar:",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "info": "Mostrando de _START_ a _END_ de _TOTAL_ entradas",
            },
            "drawCallback": function(settings) {
                var api = this.api();
                var pages = api.page.info().pages;

                if (pages <= 1) {
                    $('.dataTables_paginate').hide();
                } else {
                    $('.dataTables_paginate').show();
                }
            }

        });



        var table = $('#miTabla3').DataTable({
            "pageLength":3,
            "lengthChange": false,
            "language": {
                "emptyTable": "No hay registros disponibles",
                "zeroRecords": "No se encontraron registros coincidentes",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "search" : "Buscar:",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "info": "Mostrando de _START_ a _END_ de _TOTAL_ entradas",
            },
            "drawCallback": function(settings) {
                var api = this.api();
                var pages = api.page.info().pages;

                if (pages <= 1) {
                    $('.dataTables_paginate').hide();
                } else {
                    $('.dataTables_paginate').show();
                }
            }

        });

        $('#filtroEstado').on('change', function() {
            var estado = $(this).val();
            table.column(2).search(estado).draw();

        });

        $('#limpiarFiltros').on('click', function() {
            $('#filtroEstado').val('');
            table.search('').columns().search('').draw();
        });
    });


</script>
<!-- DataTable -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
<!------>


<script>
    // Seleccionar todos los elementos p dentro de la clase bar
    var emojis = document.querySelectorAll(".bar p");

    // Iterar sobre cada emoji y agregar un event listener
    emojis.forEach(function(emoji) {
        emoji.onclick = function() {
            var p = emoji.innerHTML;
            document.querySelector("input").value += p;
        };
    });
</script>

</body>

</html>